# AIdea: Solar PV Forecast - Surplux

[AIdea 太陽能發電量預測競賽, ITRI, Surplux Energy](https://aidea-web.tw/topic/09679060-518a-4e6f-94db-53c7d8de8138)

## 簡介

淨零排放 (Net Zero Emissions) 已成為國際共識與全球目標，目前已累積逾 136 國參與，甚至部分國家已達初期設定標。近來台灣擬定 4 大策略，預計 2050 年實現淨零碳排，而提升太陽光電、風力發電等再生能源發電比例也是能源轉型的重要方向。

本議題透過太陽能發電歷史資料如日射量、裝置容量…等，以機器學習的方法預測各地的太陽能發電量，期望參賽者能掌握影響太陽能發電量的關鍵因素，並對於未來太陽能建置細節擬定能有相當程度的助益。

獲獎條件：在 Private Leaderboard 低於 baseline (RMSE < 260)

## 活動時間

議題進行時間以台灣時間（UTC+8 小時）為主，其時程如下:

- 2022/04/20 開放報名及下載訓練資料集
- 2022/06/21 23:59:59 上傳答案截止
- 2022/06/23 公布 Private Leaderboard，開始上傳報告
- 2022/06/30 23:59:59 上傳報告截止
- 2022/07/06 公布得獎名單

## 排名

參加期間總共上傳 18 次[^1] 答案，最終排名如下

|         |   RMSE    |  排名  |
| :------ | :-------: | :----: |
| Public  | 238.85634 | 9/179  |
| Private | 145.55749 | 20/179 |

[^1]: 每次上傳答案在 Public Leaderboard 的分數請參考 `src/submission/README.md`

## 官方資料

本議題提供之逐 1 日資料如下：

- 發電量訓練集，共 3,585 筆（檔案名稱：train.csv）
- 發電量測試集，共 1,540 筆（檔案名稱：test.csv）

| 欄位名稱     | 欄位說明                                             |
| ------------ | ---------------------------------------------------- |
| ID           | 資料編號                                             |
| Date         | 資料日期                                             |
| Temp         | 當日平均氣溫(°C)[^2]                                 |
| Temp_m       | 模溫計：模板溫度(°C)[^3]                             |
| Irradiance   | 日射量(MJ/m²)[^2]                                    |
| Irradiance_m | 日照計：日射量(Wh/m²)[^3]                            |
| Generation   | 預測目標 - 發電量(kWh)                               |
| Capacity     | 裝置容量(kWp)                                        |
| Lat          | 緯度                                                 |
| Lon          | 經度                                                 |
| Angle        | 面向角度(0 為正南方，正值為偏向西方，負值為偏向東方) |
| Module       | 模組型號[^4]                                         |

[^2]: 外部資料來源：農作物災害預警平台
[^3]: 因於硬體限制，非所有型號皆有資料
[^4]:
    模組型號
    | | MM60-6RT-300 | SEC-6M-60A-295 | AUO PM060MW3 320W | AUO PM060MW3 325W |
    | --------------- | ------------ | -------------- | ----------------- | ----------------- |
    | 峰值輸出(Pmax) | 300W | 295W | 320W | 325W |
    | 峰值電壓(Vmp) | 32.61 | 31.6 | 33.48 | 33.66 |
    | 峰值電流(Imp) | 9.2 | 9.34 | 9.56 | 9.66 |
    | 開路電壓(Voc) | 38.97 | 39.4 | 40.9 | 41.1 |
    | 短路電流(Isc) | 9.68 | 9.85 | 10.24 | 10.35 |
    | 模組效能(%) | 18.44% | 17.74% | 19.2% | 19.5% |

    以官方公開資料為準。STC 標準測試狀況︰1000W/m²，空氣大氣光程 AM 1.5，25℃

## 外部資料

[中央氣象局觀測資料查詢系統](https://e-service.cwb.gov.tw/HistoryDataQuery/downloads/Readme.pdf)逐 1 小時觀測資料

| 欄位名稱 | 欄位說明            |
| -------- | ------------------- |
| GloblRad | 全天空日射量(MJ/m²) |

使用套件 [pvlib-python](https://github.com/pvlib/pvlib-python) 計算逐 1 小時晴空輻射

| 欄位名稱           | 欄位說明           |
| ------------------ | ------------------ |
| ClearSkyIrradiance | 晴空輻射量(kWh/m²) |

## 方法

比賽題目是預測多個案場在未來 2021.10.29 ~ 2022.02.17 間的逐日累積發電量

相對現在時間點來說，給定的預測範圍已經是過去式，可以合法取得歷史輻射資料，這個題目實質上是在預測發電機組的陣列轉換率[^5]

[^5]: Array to Inverter Ratio

### Rule Based Method

| 實驗                                       | 方法                                             | RMSE      |
| :----------------------------------------- | :----------------------------------------------- | :-------- |
| rule-based-groupby-lat-lon                 | 將歷史資料基於經緯分組，計算轉換率用於推算發電量 | 277.33373 |
| rule-based-groupby-lat-lon-module-capacity | 將歷史資料基於經緯及模組容量分組，計算轉換率用於推算發電量     | 278.91238 |

在第 1 ~ 5 次提交，使用 Rule Based 方法計算每個案場的歷史陣列轉換率，再乘以預測範圍的觀測輻射推算發電量，作為其他模型的參考基準，結果顯示 Rule Based 方法的 RMSE 約為 277 單位

為了準確計算每個案場的歷史陣列轉換率，先依據經度、緯度、機組型號及裝置容量替原始資料分組，然後再使用歷史發電量、觀測輻射及裝置容量計算每個群組的陣列轉換率

### Machine Learning Method

在後來的實驗，使用 XGboost 預測逐 1 日的發電量，為了提高預測準確性，加入 2 項外部資料，包括中央氣象局觀測資料查詢系統的逐 1 小時輻射量，以及套件 pvlib-python 以物理方式計算的逐 1 小時晴空輻射量，具體的輸入變數組成如下：

- 逐小時觀測輻射 48 筆：目標日及過去 1 日的 24 小時輻射量，取自觀測資料查詢系統，與發電量的相關性最高
- 逐小時晴空輻射 48 筆：目標日及過去 1 日的 24 小時晴空輻射量，使用物理方式計算，作為最大輻射量的參考值
- 逐日觀測輻射 1 筆：目標日的整日累計輻射量，取自議題提供之原始資料，由於是累計量，能提供的資訊較少
- 案場裝置容量：每個案場的裝置容量，作為最大發電量的參考值
- Day Of Year Transformed：日期參數，表示目標日為一年中的第幾天，能幫助模型理解季節變化

過程中，曾經嘗試加入中央氣象局的觀測氣溫及雲量等資料，但發現沒有任何改善，因此最終被移除

### Group by Longitude

最開始轉換到 Machine Learning 方法的時候，在 Public Leaderboard 的 RMSE 比起 Rule Based 方法沒有改善太多，原因是部分案場的訓練資料過少 (尤其是 AUO PM060MW3 325W 僅有 20 筆)，模型泛化能力嚴重不足

為了解決上述問題，在訓練模型的時候僅採用經度分組，試圖在不大幅增加問題複雜度的前提下[^6]，提升每個群組的資料量，輸入變數的裝置容量用於區分組內不同案場的資料；這個方法明顯改善了模型的泛化能力，在 Public Leaderboard 的 RMSE 從 258 單位下降至 238 單位

**依據經度、緯度、機組型號及裝置容量分組的各組資料量**
| Module | Capacity | Lat | Lon | Count |
| ----------------- | -------- | ------ | ------ | ----- |
| MM60-6RT-300 | 438.3 | 25.11 | 121.26 | 319 |
| MM60-6RT-300 | 499.8 | 25.11 | 121.26 | 507 |
| MM60-6RT-300 | 498.6 | 25.03 | 121.08 | 316 |
| SEC-6M-60A-295 | 283.2 | 24.98 | 121.03 | 316 |
| AUO PM060MW3 320W | 246.4 | 24.107 | 120.44 | 395 |
| AUO PM060MW3 320W | 492.8 | 24.107 | 120.44 | 393 |
| AUO PM060MW3 320W | 278.4 | 24.09 | 120.52 | 158 |
| AUO PM060MW3 320W | 267.52 | 24.08 | 120.52 | 160 |
| AUO PM060MW3 325W | 343.2 | 24.08 | 120.52 | 20 |
| AUO PM060MW3 320W | 99.2 | 24.08 | 120.5 | 392 |
| AUO PM060MW3 320W | 99.84 | 24.07 | 120.48 | 160 |
| AUO PM060MW3 320W | 352 | 24.07 | 120.47 | 154 |
| AUO PM060MW3 320W | 314.88 | 24.06 | 120.47 | 132 |
| AUO PM060MW3 320W | 498.56 | 24.04 | 120.52 | 162 |

**依據經度分組的各組資料量**
| Lon | Count |
| ------ | ----- |
| 121.26 | 826 |
| 121.08 | 316 |
| 121.03 | 316 |
| 120.52 | 500 |
| 120.5 | 392 |
| 120.48 | 160 |
| 120.47 | 286 |
| 120.44 | 788 |

[^6]: 不同區域，或甚至同區域的案場，可能因為人為、環境或設備保養狀況等因素，而有不同的發電效率，混在一起訓練會增加問題複雜度

## 結論

在這個比賽，最終取得了 Public 前 5% (9/179) 及 Private 前 11% (20/179) 的成績

<p align="center">
  <img src="./src/submission/position.png" />
</p>

從 Public 及 Private 的成績落差，可以推測 Public Dataset 與 Private Dataset 的資料特性有顯著差異，而我的模型對 Public 過於擬合

在倒數 3 次提交中，亦曾嘗試調整 XGboost 的超參數降低擬合，由於它們的 RMSE 都沒有低於先前最佳的 238 單位，因此最終仍以該次提交的結果作為 Private Submission

對於未來的類似情況，建議將 Public Leaderboard 的結果作為參考即可，實際在選擇 Private Submission 的時候，應該使用其他更平衡的指標，例如：將訓練資料依月份提取固定比例，作為驗證資料
